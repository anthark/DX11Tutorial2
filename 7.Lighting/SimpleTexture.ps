#include "SceneCB.h"

Texture2D colorTexture : register (t0);

SamplerState colorSampler : register(s0);

struct VSOutput
{
    float4 pos : SV_Position;
    float4 worldPos : POSITION;
    float3 norm : NORMAL;
    float2 uv : TEXCOORD;
};

float4 ps(VSOutput pixel) : SV_Target0
{
    float3 finalColor = float3(0,0,0);

    float3 color = colorTexture.Sample(colorSampler, pixel.uv).xyz;

    for (int i = 0; i < lightCount.x; i++)
    {
        float3 lightDir = lights[i].pos.xyz - pixel.worldPos.xyz;
        float lightDist = length(lightDir);
        lightDir /= lightDist;

        float atten = clamp(dot(lightDir, pixel.norm) / (lightDist * lightDist), 0, 1);

        finalColor += color * atten * lights[i].color.xyz;
    }

    return float4(finalColor, 1.0);
}
